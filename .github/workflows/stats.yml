name: Generate GitHub Analytics SVGs

on:
  schedule:
    # Run every 6 hours (4 times daily)
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create dist directory
        run: mkdir -p dist

      # GitHub Stats Card
      - name: Generate GitHub Stats SVG
        run: |
          curl -s "https://github-readme-stats.vercel.app/api?username=puoch1of1&show_icons=true&include_all_commits=true&count_private=true&rank_icon=github&theme=tokyonight&hide_border=true" \
            -o dist/github-stats.svg \
            -H "User-Agent: Mozilla/5.0"
          
          # Verify SVG was generated and is not empty or error
          if [ ! -s dist/github-stats.svg ]; then
            echo "‚ùå Stats SVG is empty"
            exit 1
          fi
          if grep -qi "error" dist/github-stats.svg; then
            echo "‚ùå Stats generation returned error"
            cat dist/github-stats.svg
            exit 1
          fi
          echo "‚úÖ GitHub Stats SVG generated ($(wc -c < dist/github-stats.svg) bytes)"

      # GitHub Streak Stats Card
      - name: Generate Streak Stats SVG
        run: |
          curl -s "https://github-readme-streak-stats.herokuapp.com?user=puoch1of1&theme=tokyonight&hide_border=true" \
            -o dist/github-streak.svg \
            -H "User-Agent: Mozilla/5.0"
          
          if [ ! -s dist/github-streak.svg ]; then
            echo "‚ùå Streak SVG is empty"
            exit 1
          fi
          if grep -qi "error" dist/github-streak.svg; then
            echo "‚ùå Streak generation returned error"
            cat dist/github-streak.svg
            exit 1
          fi
          echo "‚úÖ Streak Stats SVG generated ($(wc -c < dist/github-streak.svg) bytes)"

      # Top Languages Card
      - name: Generate Top Languages SVG
        run: |
          curl -s "https://github-readme-stats.vercel.app/api/top-langs/?username=puoch1of1&layout=compact&langs_count=8&theme=tokyonight&hide_border=true" \
            -o dist/github-top-langs.svg \
            -H "User-Agent: Mozilla/5.0"
          
          if [ ! -s dist/github-top-langs.svg ]; then
            echo "‚ùå Top Languages SVG is empty"
            exit 1
          fi
          if grep -qi "error" dist/github-top-langs.svg; then
            echo "‚ùå Top Languages generation returned error"
            cat dist/github-top-langs.svg
            exit 1
          fi
          echo "‚úÖ Top Languages SVG generated ($(wc -c < dist/github-top-langs.svg) bytes)"

      # List and verify all SVGs
      - name: Verify generated SVGs
        run: |
          echo "üìä Generated Analytics SVGs:"
          ls -lh dist/
          echo ""
          echo "Checking SVG validity..."
          for svg in dist/*.svg; do
            if grep -q "<svg" "$svg"; then
              echo "‚úÖ $svg is valid SVG"
            else
              echo "‚ùå $svg is NOT a valid SVG"
              exit 1
            fi
          done

      # Deploy SVGs to output branch
      - name: Deploy to output branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: output
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update GitHub Analytics SVGs [skip ci]"
          single-commit: true

      - name: Workflow completion
        run: |
          echo "‚úÖ Workflow completed successfully"
          echo "SVGs are now available at:"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-stats.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-streak.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-top-langs.svg"
