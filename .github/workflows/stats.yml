name: Generate GitHub Analytics SVGs

on:
  schedule:
    # Run every 6 hours (4 times daily)
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create dist directory
        run: mkdir -p dist

      # GitHub Stats Card
      - name: Generate GitHub Stats SVG
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."
            curl -s "https://github-readme-stats.vercel.app/api?username=puoch1of1&show_icons=true&include_all_commits=true&count_private=true&rank_icon=github&theme=tokyonight&hide_border=true" \
              -o dist/github-stats.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-stats.svg ] && ! grep -qi "deployment\|unavailable\|error" dist/github-stats.svg 2>/dev/null; then
              echo "âœ… GitHub Stats SVG generated ($(wc -c < dist/github-stats.svg) bytes)"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          echo "âš ï¸ Stats service unavailable after $max_attempts attempts"
          echo "This is expected if vercel.app is under maintenance"
          exit 0

      # GitHub Streak Stats Card
      - name: Generate Streak Stats SVG
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."
            curl -s "https://github-readme-streak-stats.herokuapp.com?user=puoch1of1&theme=tokyonight&hide_border=true" \
              -o dist/github-streak.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-streak.svg ] && ! grep -qi "error\|dyno\|unavailable" dist/github-streak.svg 2>/dev/null; then
              echo "âœ… Streak Stats SVG generated ($(wc -c < dist/github-streak.svg) bytes)"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          echo "âš ï¸ Streak service unavailable after $max_attempts attempts"
          exit 0

      # Top Languages Card
      - name: Generate Top Languages SVG
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."
            curl -s "https://github-readme-stats.vercel.app/api/top-langs/?username=puoch1of1&layout=compact&langs_count=8&theme=tokyonight&hide_border=true" \
              -o dist/github-top-langs.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-top-langs.svg ] && ! grep -qi "deployment\|unavailable\|error" dist/github-top-langs.svg 2>/dev/null; then
              echo "âœ… Top Languages SVG generated ($(wc -c < dist/github-top-langs.svg) bytes)"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          echo "âš ï¸ Languages service unavailable after $max_attempts attempts"
          exit 0

      # List and verify all SVGs
      - name: Verify generated SVGs
        run: |
          echo "ðŸ“Š Generated Analytics SVGs:"
          ls -lh dist/
          echo ""
          echo "Checking SVG validity..."
          for svg in dist/*.svg; do
            if grep -q "<svg" "$svg"; then
              echo "âœ… $svg is valid SVG"
            else
              echo "âŒ $svg is NOT a valid SVG"
              exit 1
            fi
          done

      # Deploy SVGs to output branch
      - name: Deploy to output branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: output
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update GitHub Analytics SVGs [skip ci]"
          single-commit: true

      - name: Workflow completion
        run: |
          echo "âœ… Workflow completed successfully"
          echo "SVGs are now available at:"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-stats.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-streak.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-top-langs.svg"
