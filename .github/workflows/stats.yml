name: Generate GitHub Analytics SVGs

on:
  schedule:
    # Run every 6 hours (4 times daily)
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create dist directory
        run: mkdir -p dist

      # GitHub Stats Card - Try primary service first, fallback to alternate
      - name: Generate GitHub Stats SVG
        continue-on-error: true
        run: |
          max_attempts=3
          attempt=1
          success=false
          
          # Try primary service (github-readme-stats)
          while [ $attempt -le $max_attempts ] && [ "$success" = false ]; do
            echo "Attempt $attempt/$max_attempts for github-readme-stats..."
            curl -s "https://github-readme-stats.vercel.app/api?username=puoch1of1&show_icons=true&include_all_commits=true&count_private=true&rank_icon=github&theme=tokyonight&hide_border=true" \
              -o dist/github-stats.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-stats.svg ] && grep -q "<svg" dist/github-stats.svg 2>/dev/null && ! grep -qi "deployment\|unavailable\|error\|503\|500" dist/github-stats.svg 2>/dev/null; then
              echo "‚úÖ GitHub Stats SVG generated ($(wc -c < dist/github-stats.svg) bytes)"
              success=true
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          if [ "$success" = false ]; then
            echo "‚ö†Ô∏è Primary stats service unavailable"
            # Try alternate service
            echo "Trying alternate service: github-readme-stats-git-masterrstaa-rickstaa.vercel.app"
            curl -s "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=puoch1of1&show_icons=true&include_all_commits=true&count_private=true&rank_icon=github&theme=tokyonight&hide_border=true" \
              -o dist/github-stats.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-stats.svg ] && grep -q "<svg" dist/github-stats.svg; then
              echo "‚úÖ Stats generated via alternate service"
              success=true
            fi
          fi
          
          if [ "$success" = false ]; then
            echo "‚ö†Ô∏è All stats services unavailable - keeping existing SVG"
          fi

      # GitHub Streak Stats Card
      - name: Generate Streak Stats SVG
        continue-on-error: true
        run: |
          max_attempts=3
          attempt=1
          success=false
          
          while [ $attempt -le $max_attempts ] && [ "$success" = false ]; do
            echo "Attempt $attempt/$max_attempts..."
            curl -s "https://github-readme-streak-stats.herokuapp.com?user=puoch1of1&theme=tokyonight&hide_border=true" \
              -o dist/github-streak.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-streak.svg ] && grep -q "<svg" dist/github-streak.svg 2>/dev/null && ! grep -qi "error\|dyno\|unavailable\|503\|500" dist/github-streak.svg 2>/dev/null; then
              echo "‚úÖ Streak Stats SVG generated ($(wc -c < dist/github-streak.svg) bytes)"
              success=true
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          if [ "$success" = false ]; then
            echo "‚ö†Ô∏è Streak service unavailable - trying alternate endpoint"
            curl -s "https://streak-stats.demolab.com?user=puoch1of1&theme=tokyonight&hide_border=true" \
              -o dist/github-streak.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-streak.svg ] && grep -q "<svg" dist/github-streak.svg; then
              echo "‚úÖ Streak generated via alternate service"
            else
              echo "‚ö†Ô∏è All streak services unavailable - keeping existing SVG"
            fi
          fi

      # Top Languages Card
      - name: Generate Top Languages SVG
        continue-on-error: true
        run: |
          max_attempts=3
          attempt=1
          success=false
          
          while [ $attempt -le $max_attempts ] && [ "$success" = false ]; do
            echo "Attempt $attempt/$max_attempts..."
            curl -s "https://github-readme-stats.vercel.app/api/top-langs/?username=puoch1of1&layout=compact&langs_count=8&theme=tokyonight&hide_border=true" \
              -o dist/github-top-langs.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-top-langs.svg ] && grep -q "<svg" dist/github-top-langs.svg 2>/dev/null && ! grep -qi "deployment\|unavailable\|error\|503\|500" dist/github-top-langs.svg 2>/dev/null; then
              echo "‚úÖ Top Languages SVG generated ($(wc -c < dist/github-top-langs.svg) bytes)"
              success=true
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
            fi
            ((attempt++))
          done
          
          if [ "$success" = false ]; then
            echo "‚ö†Ô∏è Languages service unavailable - trying alternate"
            curl -s "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api/top-langs/?username=puoch1of1&layout=compact&langs_count=8&theme=tokyonight&hide_border=true" \
              -o dist/github-top-langs.svg \
              -H "User-Agent: Mozilla/5.0" \
              --connect-timeout 10 \
              --max-time 30
            
            if [ -s dist/github-top-langs.svg ] && grep -q "<svg" dist/github-top-langs.svg; then
              echo "‚úÖ Languages generated via alternate service"
            else
              echo "‚ö†Ô∏è All languages services unavailable - keeping existing SVG"
            fi
          fi

      # Verify at least some SVGs exist
      - name: Check SVG files
        run: |
          echo "üìä Checking for SVG files in dist/:"
          ls -lh dist/ || echo "No files in dist/"
          
          svg_count=$(find dist/ -name "*.svg" 2>/dev/null | wc -l)
          echo "Found $svg_count SVG files"
          
          if [ $svg_count -eq 0 ]; then
            echo "‚ö†Ô∏è No SVGs generated - workflow will skip deployment"
            echo "This is normal if all external services are down"
            exit 0
          fi

      # Deploy SVGs to output branch (only if we have SVGs)
      - name: Deploy to output branch
        if: success()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: output
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update GitHub Analytics SVGs [skip ci]"
          single-commit: true

      - name: Workflow completion
        run: |
          echo "‚úÖ Workflow completed"
          echo "SVGs available at:"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-stats.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-streak.svg"
          echo "  - https://raw.githubusercontent.com/puoch1of1/puoch1of1/output/github-top-langs.svg"
